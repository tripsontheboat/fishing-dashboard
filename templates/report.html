{% extends "base.html" %}
{% block content %}

<h1>Report</h1>
<div class="form-card" style="margin-bottom: 20px;">
    <h2 style="margin-bottom: 10px;">Map View</h2>
    <div id="report-map" style="height: 350px; border-radius: 8px;"></div>
</div>

<!-- Filter Box -->
<div class="filter-box">
    <form method="get">
        <label>Start Date:</label>
        <input type="date" name="start" value="{{ request.args.get('start', '') }}">

        <label>End Date:</label>
        <input type="date" name="end" value="{{ request.args.get('end', '') }}">

        <label>Species:</label>
        <select name="species">
            <option value="all">All</option>
            {% for s in species_list %}
                <option value="{{ s.species }}" {% if request.args.get('species') == s.species %}selected{% endif %}>
                    {{ s.species }}
                </option>
            {% endfor %}
        </select>

        <label>Sort:</label>
        <select name="sort">
            <option value="newest">Newest First</option>
            <option value="oldest" {% if request.args.get('sort') == 'oldest' %}selected{% endif %}>Oldest First</option>
        </select>

        <button type="submit" class="save-btn">Apply</button>
    </form>
</div>

<!-- Summary Cards -->
<div class="stats-container">
    <div class="stat-card">
        <h2>{{ total_trips }}</h2>
        <p>Total Trips</p>
    </div>

    <div class="stat-card">
        <h2>{{ total_fish }}</h2>
        <p>Total Fish Counted</p>
    </div>

    <div class="stat-card">
        <h2>{{ unique_species }}</h2>
        <p>Unique Species</p>
    </div>
</div>

<!-- Data Table -->
<table>
    <tr>
        <th>Date</th>
        <th>Location</th>
        <th>Species</th>
        <th>Count</th>
        <th>Bait</th>
        <th>Size</th>
        <th>Water</th>
        <th>Platform</th>
        <th>Water Temp</th>
        <th>Wind</th>
        <th>Wave Height</th>
        <th>Image</th>
    </tr>

    {% for row in data %}
    <tr>
        <td>{{ row.date }}</td>
        <td>{{ row.location }}</td>
        <td>{{ row.species }}</td>
        <td>{{ row.count }}</td>
        <td>{{ row.bait }}</td>
        <td>{{ row.size }}</td>
        <td>{{ row.water }}</td>
        <td>{{ row.platform }}</td>
        <td>{{ row.water_temp }}</td>
        <td>{{ row.wind }}</td>
        <td>{{ row.wave_height }}</td>

        <td>
            {% if row.image %}
                <img src="{{ url_for('static', filename='uploads/' ~ row.image) }}" 
                     style="width:60px; border-radius:4px;">
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
<script>
    const entries = {{ data | tojson }};

    if (entries.length === 0) {
        document.getElementById("report-map").innerHTML =
            "<p style='padding:10px;color:#666;'>No results to display on the map.</p>";
    } else {
        const map = L.map('report-map');

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        const markers = [];

        entries.forEach(e => {
            if (e.lat && e.lng) {
                const marker = L.marker([e.lat, e.lng]).addTo(map);
                marker.bindPopup(`
                    <strong>${e.species || "Unknown species"}</strong><br>
                    ${e.location || ""}<br>
                    ${e.date || ""}
                `);
                markers.push(marker);
            }
        });

        if (markers.length > 0) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        } else {
            map.setView([0, 0], 2);
            document.getElementById("report-map").innerHTML =
                "<p style='padding:10px;color:#666;'>No coordinates available for these results.</p>";
        }
    }
</script>

{% endblock %}


