<!DOCTYPE html>
<html>
<head>
    <title>Fishing Dashboard</title>

    <!-- Leaflet CSS + JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #map {
            height: 400px;
            margin-bottom: 20px;
            border: 2px solid #ccc;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        img {
            max-width: 120px;
            border-radius: 6px;
        }
    </style>
</head>

<body>

<h1>Fishing Dashboard</h1>

<!-- MAP -->
<div id="map"></div>
<div style="
    background:#f7f7f7;
    padding:15px;
    border-radius:8px;
    width:300px;
    margin:15px 0;
">
    <strong>Quick Stats</strong><br>
    Total Trips: {{ total_trips }}<br>
    Total Fish Caught: {{ total_fish }}<br>
    Most Common Species: {{ most_common_species or "N/A" }}
</div>

<!-- FILTERS -->
<form method="get" action="/">
    <label>Start Date:</label>
    <input type="date" name="start">

    <label>End Date:</label>
    <input type="date" name="end">

    <label>Species:</label>
    <select name="species">
        <option value="all">All</option>
        {% for s in species_list %}
            <option value="{{ s.species }}">{{ s.species }}</option>
        {% endfor %}
    </select>

    <label>Sort:</label>
    <select name="sort">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
    </select>

    <button type="submit">Apply</button>
</form>
<div style="margin: 10px 0;">
<a href="/add">âž• Add New Entry</a>
&nbsp; | &nbsp;
<a href="/report">ðŸ“Š Reports</a>
</div>
<!-- TABLE OF ENTRIES -->
<table>
    <tr>
        <th>Date</th>
        <th>Location</th>
        <th>Species</th>
        <th>Count</th>
        <th>Bait</th>
        <th>Size</th>
        <th>Water</th>
        <th>Platform</th>
        <th>Image</th>
        <th>Actions</th>
    </tr>

    {% for row in data %}
    <tr>
        <td>{{ row.date }}</td>
        <td>{{ row.location }}</td>
        <td>{{ row.species }}</td>
        <td>{{ row.count }}</td>
        <td>{{ row.bait }}</td>
        <td>{{ row.size }}</td>
        <td>{{ row.water }}</td>
        <td>{{ row.platform }}</td>
        <td>
            {% if row.image %}
                <img src="/static/uploads/{{ row.image }}">
            {% endif %}
        </td>
        <td>
            <a href="/edit/{{ row.id }}">Edit</a> |
            <a href="/delete/{{ row.id }}">Delete</a>
        </td>
    </tr>
    {% endfor %}
</table>

<!-- MAP SCRIPT -->
<script>
    // Create map centered on Massachusetts
    var map = L.map('map').setView([42.3, -71.0], 8);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(map);

    // Load entries from Flask
    var entries = {{ data|tojson }};

    // Species â†’ marker color mapping (VALID COLORS ONLY)
    const speciesColors = {
        "False Albacore": "green",
        "Bluefish": "blue",
        "Bonefish": "yellow",
        "Barracuda": "orange",
        "Bonito": "violet",
        "Sea Bass": "red",
        "Other": "grey"
    };

    // Function to generate colored marker icons
    function getColoredIcon(color) {
        return L.icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    // Add markers with speciesâ€‘based colors
    entries.forEach(function(entry) {
        if (entry.lat && entry.lng) {

            // Pick color based on species, fallback to grey
            const color = speciesColors[entry.species] || "grey";

            L.marker([entry.lat, entry.lng], {
                icon: getColoredIcon(color)
            })
            .addTo(map)
            .bindPopup(
                `<strong>${entry.species || "Unknown species"}</strong><br>
                 ${entry.date || ""}<br>
                 ${entry.location || ""}`
            );
        }
    });
</script>

</body>
</html>

